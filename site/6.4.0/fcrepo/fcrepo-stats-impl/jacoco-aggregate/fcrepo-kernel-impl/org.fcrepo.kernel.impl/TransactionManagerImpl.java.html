<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>TransactionManagerImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Repository Stats Impl</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-kernel-impl</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.kernel.impl</a> &gt; <span class="el_source">TransactionManagerImpl.java</span></div><h1>TransactionManagerImpl.java</h1><pre class="source lang-java linenums">/*
 * The contents of this file are subject to the license and copyright
 * detailed in the LICENSE and NOTICE files at the root of the source
 * tree.
 */
package org.fcrepo.kernel.impl;

import org.fcrepo.common.db.DbTransactionExecutor;
import org.fcrepo.config.FedoraPropsConfig;
import org.fcrepo.kernel.api.ContainmentIndex;
import org.fcrepo.kernel.api.Transaction;
import org.fcrepo.kernel.api.TransactionManager;
import org.fcrepo.kernel.api.cache.UserTypesCache;
import org.fcrepo.kernel.api.exception.TransactionClosedException;
import org.fcrepo.kernel.api.exception.TransactionNotFoundException;
import org.fcrepo.kernel.api.lock.ResourceLockManager;
import org.fcrepo.kernel.api.observer.EventAccumulator;
import org.fcrepo.kernel.api.services.MembershipService;
import org.fcrepo.kernel.api.services.ReferenceService;
import org.fcrepo.persistence.api.PersistentStorageSessionManager;
import org.fcrepo.search.api.SearchIndex;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import javax.inject.Inject;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import static java.util.UUID.randomUUID;

/**
 * The Fedora Transaction Manager implementation
 *
 * @author mohideen
 */
@Component
public class TransactionManagerImpl implements TransactionManager {

<span class="nc" id="L43">    private static final Logger LOGGER = LoggerFactory.getLogger(TransactionManagerImpl.class);</span>

    private final Map&lt;String, Transaction&gt; transactions;

    @Autowired
    @Qualifier(&quot;containmentIndex&quot;)
    private ContainmentIndex containmentIndex;

    @Inject
    private PersistentStorageSessionManager pSessionManager;

    @Inject
    private EventAccumulator eventAccumulator;

    @Autowired
    @Qualifier(&quot;referenceService&quot;)
    private ReferenceService referenceService;

    @Inject
    private MembershipService membershipService;

    @Inject
    @Qualifier(&quot;searchIndex&quot;)
    private SearchIndex searchIndex;

    @Inject
    private ResourceLockManager resourceLockManager;

    @Inject
    private FedoraPropsConfig fedoraPropsConfig;

    @Inject
    private DbTransactionExecutor dbTransactionExecutor;

    @Inject
    private UserTypesCache userTypesCache;

<span class="nc" id="L80">    TransactionManagerImpl() {</span>
<span class="nc" id="L81">        transactions = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L82">    }</span>

    /**
     * Periodically scan for closed transactions for cleanup
     */
    @Scheduled(fixedDelayString = &quot;#{fedoraPropsConfig.sessionTimeout}&quot;)
    public void cleanupClosedTransactions() {
<span class="nc" id="L89">        LOGGER.debug(&quot;Cleaning up expired transactions&quot;);</span>

<span class="nc" id="L91">        final var txIt = transactions.entrySet().iterator();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        while (txIt.hasNext()) {</span>
<span class="nc" id="L93">            final var txEntry = txIt.next();</span>
<span class="nc" id="L94">            final var tx = txEntry.getValue();</span>

            // Cleanup if transaction is closed and past its expiration time
<span class="nc bnc" id="L97" title="All 4 branches missed.">            if (tx.isCommitted() || tx.isRolledBack()) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (tx.hasExpired()) {</span>
<span class="nc" id="L99">                    txIt.remove();</span>
                }
<span class="nc bnc" id="L101" title="All 2 branches missed.">            } else if (tx.hasExpired()) {</span>
<span class="nc" id="L102">                LOGGER.debug(&quot;Rolling back expired transaction {}&quot;, tx.getId());</span>
                try {
                    // If the tx has expired but is not already closed, then rollback
                    // but don't immediately remove it from the list of transactions
                    // so that the rolled back status can be checked
<span class="nc" id="L107">                    tx.rollback();</span>
<span class="nc" id="L108">                } catch (final RuntimeException e) {</span>
<span class="nc" id="L109">                    LOGGER.error(&quot;Failed to rollback expired transaction {}&quot;, tx.getId(), e);</span>
<span class="nc" id="L110">                }</span>
            }

<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (tx.hasExpired()) {</span>
                // By this point the session as already been committed or rolledback by the transaction
<span class="nc" id="L115">                pSessionManager.removeSession(tx.getId());</span>
            }
<span class="nc" id="L117">        }</span>
<span class="nc" id="L118">    }</span>

    @Override
    public synchronized Transaction create() {
<span class="nc" id="L122">        String txId = randomUUID().toString();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        while (transactions.containsKey(txId)) {</span>
<span class="nc" id="L124">            txId = randomUUID().toString();</span>
        }
<span class="nc" id="L126">        final Transaction tx = new TransactionImpl(txId, this, fedoraPropsConfig.getSessionTimeout());</span>
<span class="nc" id="L127">        transactions.put(txId, tx);</span>
<span class="nc" id="L128">        return tx;</span>
    }

    @Override
    public Transaction get(final String transactionId) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (transactions.containsKey(transactionId)) {</span>
<span class="nc" id="L134">            final Transaction transaction = transactions.get(transactionId);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (transaction.hasExpired()) {</span>
<span class="nc" id="L136">                transaction.rollback();</span>
<span class="nc" id="L137">                throw new TransactionClosedException(&quot;Transaction with transactionId: &quot; + transactionId +</span>
<span class="nc" id="L138">                    &quot; expired at &quot; + transaction.getExpires() + &quot;!&quot;);</span>
            }
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (transaction.isCommitted()) {</span>
<span class="nc" id="L141">                throw new TransactionClosedException(&quot;Transaction with transactionId: &quot; + transactionId +</span>
                        &quot; has already been committed.&quot;);
            }
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (transaction.isRolledBack()) {</span>
<span class="nc" id="L145">                throw new TransactionClosedException(&quot;Transaction with transactionId: &quot; + transactionId +</span>
                        &quot; has already been rolled back.&quot;);
            }
<span class="nc" id="L148">            return transaction;</span>
        } else {
<span class="nc" id="L150">            throw new TransactionNotFoundException(&quot;No Transaction found with transactionId: &quot; + transactionId);</span>
        }
    }

    protected PersistentStorageSessionManager getPersistentStorageSessionManager() {
<span class="nc" id="L155">        return pSessionManager;</span>
    }

    protected ContainmentIndex getContainmentIndex() {
<span class="nc" id="L159">        return containmentIndex;</span>
    }

    protected SearchIndex getSearchIndex() {
<span class="nc" id="L163">        return searchIndex;</span>
    }


    protected EventAccumulator getEventAccumulator() {
<span class="nc" id="L168">        return eventAccumulator;</span>
    }

    protected ReferenceService getReferenceService() {
<span class="nc" id="L172">        return referenceService;</span>
    }

    protected MembershipService getMembershipService() {
<span class="nc" id="L176">        return membershipService;</span>
    }

    protected ResourceLockManager getResourceLockManager() {
<span class="nc" id="L180">        return resourceLockManager;</span>
    }

    protected UserTypesCache getUserTypesCache() {
<span class="nc" id="L184">        return userTypesCache;</span>
    }

    public DbTransactionExecutor getDbTransactionExecutor() {
<span class="nc" id="L188">        return dbTransactionExecutor;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>