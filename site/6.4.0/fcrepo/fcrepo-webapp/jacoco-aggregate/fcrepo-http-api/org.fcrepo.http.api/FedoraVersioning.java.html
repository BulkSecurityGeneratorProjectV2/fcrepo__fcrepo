<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>FedoraVersioning.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Repository Deployable Web Application</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-http-api</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.http.api</a> &gt; <span class="el_source">FedoraVersioning.java</span></div><h1>FedoraVersioning.java</h1><pre class="source lang-java linenums">/*
 * The contents of this file are subject to the license and copyright
 * detailed in the LICENSE and NOTICE files at the root of the source
 * tree.
 */
package org.fcrepo.http.api;

import com.google.common.annotations.VisibleForTesting;
import io.micrometer.core.annotation.Timed;

import org.fcrepo.http.commons.responses.HtmlTemplate;
import org.fcrepo.http.commons.responses.LinkFormatStream;
import org.fcrepo.kernel.api.exception.CannotCreateMementoException;
import org.fcrepo.kernel.api.exception.InvalidChecksumException;
import org.fcrepo.kernel.api.exception.MementoDatetimeFormatException;
import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;
import org.fcrepo.kernel.api.models.FedoraResource;
import org.slf4j.Logger;
import org.springframework.context.annotation.Scope;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.BadRequestException;
import javax.ws.rs.DELETE;
import javax.ws.rs.GET;
import javax.ws.rs.HeaderParam;
import javax.ws.rs.OPTIONS;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.Link;
import javax.ws.rs.core.Link.Builder;
import javax.ws.rs.core.Request;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriInfo;
import java.io.IOException;
import java.net.URI;
import java.time.Instant;
import java.time.ZoneId;
import java.util.Arrays;
import java.util.Comparator;
import java.util.HashSet;
import java.util.Set;
import java.util.stream.Collectors;

import static javax.ws.rs.core.Response.Status.METHOD_NOT_ALLOWED;
import static javax.ws.rs.core.Response.ok;
import static javax.ws.rs.core.Response.status;

import static org.fcrepo.http.commons.domain.RDFMediaType.APPLICATION_LINK_FORMAT;
import static org.fcrepo.http.commons.domain.RDFMediaType.JSON_LD;
import static org.fcrepo.http.commons.domain.RDFMediaType.N3_ALT2_WITH_CHARSET;
import static org.fcrepo.http.commons.domain.RDFMediaType.N3_WITH_CHARSET;
import static org.fcrepo.http.commons.domain.RDFMediaType.NTRIPLES;
import static org.fcrepo.http.commons.domain.RDFMediaType.RDF_XML;
import static org.fcrepo.http.commons.domain.RDFMediaType.TEXT_HTML_WITH_CHARSET;
import static org.fcrepo.http.commons.domain.RDFMediaType.TEXT_PLAIN_WITH_CHARSET;
import static org.fcrepo.http.commons.domain.RDFMediaType.TURTLE_WITH_CHARSET;
import static org.fcrepo.kernel.api.FedoraTypes.FCR_VERSIONS;
import static org.fcrepo.kernel.api.services.VersionService.MEMENTO_RFC_1123_FORMATTER;
import static org.slf4j.LoggerFactory.getLogger;

/**
 * @author cabeer
 * @since 9/25/14
 */
@Timed
@Scope(&quot;request&quot;)
@Path(&quot;/{path: .*}/fcr:versions&quot;)
public class FedoraVersioning extends ContentExposingResource {

<span class="nc" id="L73">    private static final Logger LOGGER = getLogger(FedoraVersioning.class);</span>

    @VisibleForTesting
    public static final String MEMENTO_DATETIME_HEADER = &quot;Memento-Datetime&quot;;

    @Context protected Request request;
    @Context protected HttpServletResponse servletResponse;
    @Context protected UriInfo uriInfo;

    @PathParam(&quot;path&quot;) protected String externalPath;


    /**
     * Default JAX-RS entry point
     */
    public FedoraVersioning() {
<span class="nc" id="L89">        super();</span>
<span class="nc" id="L90">    }</span>

    /**
     * Create a new FedoraNodes instance for a given path
     * @param externalPath the external path
     */
    @VisibleForTesting
<span class="nc" id="L97">    public FedoraVersioning(final String externalPath) {</span>
<span class="nc" id="L98">        this.externalPath = externalPath;</span>
<span class="nc" id="L99">    }</span>

    /**
     * Create a new version of a resource. If a memento-datetime header is provided, then the new version will be
     * based off the provided body using that datetime. If one was not provided, then a version is created based off
     * the current version of the resource.
     *
     * @return response
     * @throws InvalidChecksumException thrown if one of the provided digests does not match the content
     * @throws MementoDatetimeFormatException if the header value of memento-datetime is not RFC-1123 format
     */
    @POST
    public Response addVersion() {

<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (headers.getHeaderString(&quot;Slug&quot;) != null) {</span>
<span class="nc" id="L114">            throw new BadRequestException(&quot;Slug header is no longer supported for versioning label.&quot;);</span>
        }

<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (headers.getHeaderString(MEMENTO_DATETIME_HEADER) != null) {</span>
<span class="nc" id="L118">            throw new CannotCreateMementoException(MEMENTO_DATETIME_HEADER +</span>
                    &quot; header is no longer supported on versioning.&quot;);
        }

<span class="nc" id="L122">        final var transaction = transaction();</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (!transaction.isShortLived()) {</span>
<span class="nc" id="L125">            throw new BadRequestException(&quot;Version creation is not allowed within transactions.&quot;);</span>
        }

<span class="nc" id="L128">        final var resource = resource();</span>

        try {
<span class="nc" id="L131">            LOGGER.debug(&quot;Request to create version for &lt;{}&gt;&quot;, externalPath);</span>

<span class="nc" id="L133">            doInDbTxWithRetry(() -&gt; {</span>
<span class="nc" id="L134">                versionService.createVersion(transaction, resource.getFedoraId(), getUserPrincipal());</span>

                // need to commit the transaction before loading the memento otherwise it won't exist
<span class="nc" id="L137">                transaction.commitIfShortLived();</span>
<span class="nc" id="L138">            });</span>

<span class="nc" id="L140">            final var versions = reloadResource().getTimeMap().getChildren().collect(Collectors.toList());</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (versions.isEmpty()) {</span>
<span class="nc" id="L143">                throw new RepositoryRuntimeException(String.format(&quot;Failed to create a version for %s&quot;, externalPath));</span>
            }

<span class="nc" id="L146">            final var memento = versions.get(versions.size() - 1);</span>

<span class="nc" id="L148">            return createUpdateResponse(memento, true);</span>
<span class="nc" id="L149">        } catch (final Exception e) {</span>
<span class="nc" id="L150">            checkForInsufficientStorageException(e, e);</span>
<span class="nc" id="L151">            return null; // not reachable</span>
        } finally {
<span class="nc" id="L153">            transaction.releaseResourceLocksIfShortLived();</span>
        }
    }

    /**
     * Get the list of versions for the object
     *
     * @param acceptValue the rdf media-type
     * @return List of versions for the object as RDF
     * @throws IOException in case of error extracting content
     */
    @GET
    @HtmlTemplate(value = &quot;fcr:versions&quot;)
    @Produces({ TURTLE_WITH_CHARSET + &quot;;qs=1.0&quot;, JSON_LD + &quot;;qs=0.8&quot;,
        N3_WITH_CHARSET, N3_ALT2_WITH_CHARSET, RDF_XML, NTRIPLES, TEXT_PLAIN_WITH_CHARSET,
        TEXT_HTML_WITH_CHARSET, APPLICATION_LINK_FORMAT })
    public Response getVersionList(@HeaderParam(&quot;Accept&quot;) final String acceptValue) throws IOException {

<span class="nc" id="L171">        final FedoraResource theTimeMap = resource().getTimeMap();</span>
<span class="nc" id="L172">        checkCacheControlHeaders(request, servletResponse, theTimeMap, transaction());</span>

<span class="nc" id="L174">        LOGGER.debug(&quot;GET resource '{}'&quot;, externalPath());</span>

<span class="nc" id="L176">        addResourceHttpHeaders(theTimeMap);</span>

<span class="nc bnc" id="L178" title="All 4 branches missed.">        if (acceptValue != null &amp;&amp; acceptValue.equalsIgnoreCase(APPLICATION_LINK_FORMAT)) {</span>
<span class="nc" id="L179">            final String extUrl = identifierConverter().toDomain(externalPath());</span>

<span class="nc" id="L181">            final URI parentUri = URI.create(extUrl);</span>
<span class="nc" id="L182">            final Set&lt;Link&gt; versionLinks = new HashSet&lt;&gt;();</span>
<span class="nc" id="L183">            versionLinks.add(Link.fromUri(parentUri).rel(&quot;original&quot;).build());</span>
<span class="nc" id="L184">            versionLinks.add(Link.fromUri(parentUri).rel(&quot;timegate&quot;).build());</span>
            // So we don't collect the children twice, store them in an array.
<span class="nc" id="L186">            final FedoraResource[] children = theTimeMap.getChildren().toArray(FedoraResource[]::new);</span>

<span class="nc" id="L188">            Arrays.stream(children).forEach(t -&gt; {</span>
<span class="nc" id="L189">                final URI childUri = getUri(t);</span>
<span class="nc" id="L190">                versionLinks.add(Link.fromUri(childUri).rel(&quot;memento&quot;)</span>
<span class="nc" id="L191">                                     .param(&quot;datetime&quot;,</span>
<span class="nc" id="L192">                        MEMENTO_RFC_1123_FORMATTER.format(t.getMementoDatetime()))</span>
<span class="nc" id="L193">                                     .build());</span>
<span class="nc" id="L194">            });</span>
            // Based on the dates of the above mementos, add the range to the below link.
<span class="nc" id="L196">            final Instant[] mementos = Arrays.stream(children).map(FedoraResource::getMementoDatetime)</span>
<span class="nc" id="L197">                .sorted(Comparator.naturalOrder())</span>
<span class="nc" id="L198">                .toArray(Instant[]::new);</span>
<span class="nc" id="L199">            final Builder linkBuilder =</span>
<span class="nc" id="L200">                Link.fromUri(parentUri + &quot;/&quot; + FCR_VERSIONS).rel(&quot;self&quot;).type(APPLICATION_LINK_FORMAT);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (mementos.length &gt;= 2) {</span>
                // There are 2 or more Mementos so make a range.
<span class="nc" id="L203">                linkBuilder.param(&quot;from&quot;, MEMENTO_RFC_1123_FORMATTER.format(mementos[0].atZone(ZoneId.of(&quot;UTC&quot;))));</span>
<span class="nc" id="L204">                linkBuilder.param(&quot;until&quot;,</span>
<span class="nc" id="L205">                    MEMENTO_RFC_1123_FORMATTER.format(mementos[mementos.length - 1].atZone(ZoneId.of(&quot;UTC&quot;))));</span>
            }
<span class="nc" id="L207">            versionLinks.add(linkBuilder.build());</span>
<span class="nc" id="L208">            return ok(new LinkFormatStream(versionLinks.stream())).build();</span>
        } else {
<span class="nc" id="L210">            return getContent(getChildrenLimit(), theTimeMap);</span>
        }
    }

    /**
     * Outputs information about the supported HTTP methods, etc.
     *
     * @return the information about the supported HTTP methods, etc.
     */
    @OPTIONS
    public Response options() {
<span class="nc" id="L221">        final FedoraResource theTimeMap = resource().getTimeMap();</span>
<span class="nc" id="L222">        LOGGER.info(&quot;OPTIONS for '{}'&quot;, externalPath);</span>
<span class="nc" id="L223">        addResourceHttpHeaders(theTimeMap);</span>
<span class="nc" id="L224">        return ok().build();</span>
    }

    /**
     * Can't delete TimeMaps
     *
     * @return the response to a delete request.
     */
    @DELETE
    @Produces({TEXT_PLAIN_WITH_CHARSET})
    public Response delete() {
<span class="nc" id="L235">        final FedoraResource theTimeMap = resource().getTimeMap();</span>
<span class="nc" id="L236">        addResourceHttpHeaders(theTimeMap);</span>
<span class="nc" id="L237">        final String message = &quot;Timemaps are deleted with their associated resource.&quot;;</span>
<span class="nc" id="L238">        return status(METHOD_NOT_ALLOWED).entity(message).type(TEXT_PLAIN_WITH_CHARSET).build();</span>
    }

    @Override
    protected String externalPath() {
<span class="nc" id="L243">        return externalPath;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>