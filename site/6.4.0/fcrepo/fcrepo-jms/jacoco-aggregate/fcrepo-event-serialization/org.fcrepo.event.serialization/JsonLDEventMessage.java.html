<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JsonLDEventMessage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Repository JMS Module</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-event-serialization</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.event.serialization</a> &gt; <span class="el_source">JsonLDEventMessage.java</span></div><h1>JsonLDEventMessage.java</h1><pre class="source lang-java linenums">/*
 * The contents of this file are subject to the license and copyright
 * detailed in the LICENSE and NOTICE files at the root of the source
 * tree.
 */

package org.fcrepo.event.serialization;

import static java.time.format.DateTimeFormatter.ISO_INSTANT;
import static java.util.stream.Collectors.toList;

import static org.fcrepo.kernel.api.RdfLexicon.ACTIVITY_STREAMS_NAMESPACE;
import static org.fcrepo.kernel.api.RdfLexicon.PROV_NAMESPACE;
import static org.slf4j.LoggerFactory.getLogger;

import java.time.Instant;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;

import com.fasterxml.jackson.annotation.JsonSubTypes;
import com.fasterxml.jackson.annotation.JsonTypeInfo;
import org.fcrepo.kernel.api.observer.Event;

import org.slf4j.Logger;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;

/**
 * A structure used for serializing a Event into JSON
 * 
 * @author acoburn
 * @author dbernstein
 * @author whikloj
 */
<span class="nc" id="L38">public class JsonLDEventMessage {</span>

    @JsonIgnore
<span class="nc" id="L41">    private static final Logger LOGGER = getLogger(JsonLDEventMessage.class);</span>

    public static class ContextElement {

        @JsonProperty(&quot;@id&quot;)
        public final String id;

        @JsonProperty(&quot;@type&quot;)
        public final String type;

<span class="nc" id="L51">        public ContextElement(final String id) {</span>
<span class="nc" id="L52">            this.id = id;</span>
<span class="nc" id="L53">            this.type = &quot;@id&quot;;</span>
<span class="nc" id="L54">        }</span>

<span class="nc" id="L56">        public ContextElement(final String id, final String type) {</span>
<span class="nc" id="L57">            this.id = id;</span>
<span class="nc" id="L58">            this.type = type;</span>
<span class="nc" id="L59">        }</span>
    }

<span class="nc" id="L62">    public static class Context {</span>

<span class="nc" id="L64">        public final String prov = &quot;http://www.w3.org/ns/prov#&quot;;</span>

<span class="nc" id="L66">        public final String dcterms = &quot;http://purl.org/dc/terms/&quot;;</span>

<span class="nc" id="L68">        public final String type = &quot;@type&quot;;</span>

<span class="nc" id="L70">        public final String id = &quot;@id&quot;;</span>

<span class="nc" id="L72">        public final ContextElement isPartOf = new ContextElement(&quot;dcterms:isPartOf&quot;);</span>

    }

    public static class Object {

        @JsonProperty(&quot;type&quot;)
        public List&lt;String&gt; type;

        @JsonProperty(&quot;id&quot;)
        public String id;

        @JsonProperty(&quot;isPartOf&quot;)
        public String isPartOf;

<span class="nc" id="L87">        public Object() {</span>
            // Needed to deserialize class.
<span class="nc" id="L89">        }</span>

<span class="nc" id="L91">        public Object(final String id, final List&lt;String&gt; type, final String isPartOf) {</span>
<span class="nc" id="L92">            this.type = type;</span>
<span class="nc" id="L93">            this.id = id;</span>
<span class="nc" id="L94">            this.isPartOf = isPartOf;</span>
<span class="nc" id="L95">        }</span>
    }

    @JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = &quot;type&quot;)
    @JsonSubTypes({
            @JsonSubTypes.Type(value = Application.class, name = &quot;Application&quot;),
            @JsonSubTypes.Type(value = Person.class, name = &quot;Person&quot;) }
    )
    public static class Actor {
        @JsonIgnore
        public String type;

<span class="nc" id="L107">        public Actor(final String type) {</span>
<span class="nc" id="L108">            this.type = type;</span>
<span class="nc" id="L109">        }</span>
    }

    public static class Application extends Actor {

        @JsonProperty(&quot;name&quot;)
        public String name;

        public Application() {
<span class="nc" id="L118">            super(&quot;Application&quot;);</span>
<span class="nc" id="L119">        }</span>

        public Application(final String name, final String type) {
<span class="nc" id="L122">            super(type);</span>
<span class="nc" id="L123">            this.name = name;</span>
<span class="nc" id="L124">        }</span>
    }

    public static class Person extends Actor {

        @JsonProperty(&quot;id&quot;)
        public String id;

        public Person() {
<span class="nc" id="L133">            super(&quot;Person&quot;);</span>
<span class="nc" id="L134">        }</span>

        public Person(final String id, final String type) {
<span class="nc" id="L137">            super(type);</span>
<span class="nc" id="L138">            this.id = id;</span>
<span class="nc" id="L139">        }</span>
    }

    @JsonProperty(&quot;id&quot;)
    public String id;

    @JsonProperty(&quot;type&quot;)
    public List&lt;String&gt; type;

    @JsonProperty(&quot;name&quot;)
    public String name;

    @JsonProperty(&quot;published&quot;)
    public Instant published;


    @JsonProperty(&quot;actor&quot;)
    public List&lt;Actor&gt; actor;

    @JsonProperty(&quot;object&quot;)
    public Object object;

    @JsonProperty(&quot;@context&quot;)
    public List&lt;java.lang.Object&gt; context;

    public void setPublished(final String published) {
<span class="nc" id="L165">        this.published = Instant.from(ISO_INSTANT.parse(published));</span>
<span class="nc" id="L166">    }</span>

    /**
     * Populate a JsonLDEventMessage from a Event
     * 
     * @param evt The Fedora event
     * @return a JsonLDEventMessage
     */
    public static JsonLDEventMessage from(final Event evt) {

<span class="nc" id="L176">        final String baseUrl = evt.getBaseUrl();</span>

        // build objectId
<span class="nc" id="L179">        final String objectId = baseUrl + evt.getPath();</span>
        // build event types list
<span class="nc" id="L181">        final List&lt;String&gt; types = evt.getTypes()</span>
<span class="nc" id="L182">                .stream()</span>
<span class="nc" id="L183">                .map(rdfType -&gt; rdfType.getTypeAbbreviated())</span>
<span class="nc" id="L184">                .collect(toList());</span>
        // comma-separated list for names of events (since name requires string rather than array)
<span class="nc" id="L186">        final String name = String.join(&quot;, &quot;, evt.getTypes()</span>
<span class="nc" id="L187">                .stream()</span>
<span class="nc" id="L188">                .map(rdfType -&gt; rdfType.getName())</span>
<span class="nc" id="L189">                .collect(toList()));</span>
        // build resource types list
<span class="nc" id="L191">        final List&lt;String&gt; resourceTypes = new ArrayList&lt;&gt;(evt.getResourceTypes());</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (!resourceTypes.contains(PROV_NAMESPACE + &quot;Entity&quot;)) {</span>
<span class="nc" id="L193">            resourceTypes.add(PROV_NAMESPACE + &quot;Entity&quot;);</span>
        }

        // build actors list
<span class="nc" id="L197">        final List&lt;Actor&gt; actor = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L198">        actor.add(new Person(Objects.toString(evt.getUserURI()), &quot;Person&quot;));</span>
<span class="nc" id="L199">        final String softwareAgent = evt.getUserAgent();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (softwareAgent != null) {</span>
<span class="nc" id="L201">            actor.add(new Application(softwareAgent, &quot;Application&quot;));</span>
        }

<span class="nc" id="L204">        final JsonLDEventMessage msg = new JsonLDEventMessage();</span>

<span class="nc" id="L206">        msg.id = evt.getEventID();</span>
<span class="nc" id="L207">        msg.context = Arrays.asList(ACTIVITY_STREAMS_NAMESPACE, new Context());</span>
<span class="nc" id="L208">        msg.actor = actor;</span>
<span class="nc" id="L209">        msg.published = evt.getDate();</span>
<span class="nc" id="L210">        msg.type = types;</span>
<span class="nc" id="L211">        msg.name = name;</span>
<span class="nc" id="L212">        msg.object = new Object(objectId, resourceTypes, baseUrl);</span>
<span class="nc" id="L213">        return msg;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>