<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CreateResourceServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Repository Search Impl</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-kernel-impl</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.kernel.impl.services</a> &gt; <span class="el_source">CreateResourceServiceImpl.java</span></div><h1>CreateResourceServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * The contents of this file are subject to the license and copyright
 * detailed in the LICENSE and NOTICE files at the root of the source
 * tree.
 */
package org.fcrepo.kernel.impl.services;

import org.apache.jena.rdf.model.Model;

import org.fcrepo.kernel.api.RdfStream;
import org.fcrepo.kernel.api.Transaction;
import org.fcrepo.kernel.api.exception.CannotCreateResourceException;
import org.fcrepo.kernel.api.exception.InteractionModelViolationException;
import org.fcrepo.kernel.api.exception.ItemNotFoundException;
import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;
import org.fcrepo.kernel.api.identifiers.FedoraId;
import org.fcrepo.kernel.api.models.ExternalContent;
import org.fcrepo.kernel.api.models.ResourceHeaders;
import org.fcrepo.kernel.api.operations.CreateNonRdfSourceOperationBuilder;
import org.fcrepo.kernel.api.operations.NonRdfSourceOperationFactory;
import org.fcrepo.kernel.api.operations.RdfSourceOperation;
import org.fcrepo.kernel.api.operations.RdfSourceOperationFactory;
import org.fcrepo.kernel.api.operations.ResourceOperation;
import org.fcrepo.kernel.api.services.CreateResourceService;
import org.fcrepo.persistence.api.PersistentStorageSession;
import org.fcrepo.persistence.api.PersistentStorageSessionManager;
import org.fcrepo.persistence.api.exceptions.PersistentItemNotFoundException;
import org.fcrepo.persistence.api.exceptions.PersistentStorageException;
import org.fcrepo.persistence.common.MultiDigestInputStreamWrapper;
import org.slf4j.Logger;
import org.springframework.stereotype.Component;

import javax.inject.Inject;
import javax.ws.rs.BadRequestException;
import javax.ws.rs.core.Link;

import java.io.InputStream;
import java.net.URI;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import static java.util.Collections.emptyList;
import static org.fcrepo.kernel.api.RdfLexicon.ARCHIVAL_GROUP;
import static org.fcrepo.kernel.api.RdfLexicon.FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI;
import static org.fcrepo.kernel.api.RdfLexicon.FEDORA_PAIR_TREE;
import static org.fcrepo.kernel.api.RdfLexicon.NON_RDF_SOURCE;
import static org.fcrepo.kernel.api.rdf.DefaultRdfStream.fromModel;
import static org.slf4j.LoggerFactory.getLogger;
import static org.springframework.util.CollectionUtils.isEmpty;

/**
 * Create a RdfSource resource.
 * @author whikloj
 * TODO: bbpennel has thoughts about moving this to HTTP layer.
 */
@Component
<span class="fc" id="L59">public class CreateResourceServiceImpl extends AbstractService implements CreateResourceService {</span>

<span class="fc" id="L61">    private static final Logger LOGGER = getLogger(CreateResourceServiceImpl.class);</span>

    @Inject
    private PersistentStorageSessionManager psManager;

    @Inject
    private RdfSourceOperationFactory rdfSourceOperationFactory;

    @Inject
    private NonRdfSourceOperationFactory nonRdfSourceOperationFactory;

    @Override
    public void perform(final Transaction tx, final String userPrincipal, final FedoraId fedoraId,
                        final String contentType, final String filename,
                        final long contentSize, final List&lt;String&gt; linkHeaders, final Collection&lt;URI&gt; digest,
                        final InputStream requestBody, final ExternalContent externalContent) {
<span class="fc" id="L77">        final PersistentStorageSession pSession = this.psManager.getSession(tx);</span>
<span class="fc" id="L78">        checkAclLinkHeader(linkHeaders);</span>
        // Locate a containment parent of fedoraId, if exists.
<span class="fc" id="L80">        final FedoraId parentId = containmentIndex.getContainerIdByPath(tx, fedoraId, true);</span>
<span class="fc" id="L81">        checkParent(pSession, parentId);</span>

        final CreateNonRdfSourceOperationBuilder builder;
<span class="fc" id="L84">        String mimeType = contentType;</span>
<span class="fc" id="L85">        long size = contentSize;</span>
<span class="fc bfc" id="L86" title="All 4 branches covered.">        if (externalContent == null || externalContent.isCopy()) {</span>
<span class="fc" id="L87">            var contentInputStream = requestBody;</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">            if (externalContent != null) {</span>
<span class="fc" id="L89">                LOGGER.debug(&quot;External content COPY '{}', '{}'&quot;, fedoraId, externalContent.getURL());</span>
<span class="fc" id="L90">                contentInputStream = externalContent.fetchExternalContent();</span>
            }

<span class="fc" id="L93">            builder = nonRdfSourceOperationFactory.createInternalBinaryBuilder(tx, fedoraId, contentInputStream);</span>
<span class="fc" id="L94">        } else {</span>
<span class="fc" id="L95">            builder = nonRdfSourceOperationFactory.createExternalBinaryBuilder(tx, fedoraId,</span>
<span class="fc" id="L96">                    externalContent.getHandling(), externalContent.getURI());</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">            if (contentSize == -1L) {</span>
<span class="nc" id="L98">                size = externalContent.getContentSize();</span>
            }
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">            if (!digest.isEmpty()) {</span>
<span class="fc" id="L101">                final var multiDigestWrapper = new MultiDigestInputStreamWrapper(</span>
<span class="fc" id="L102">                        externalContent.fetchExternalContent(),</span>
                        digest,
<span class="fc" id="L104">                        Collections.emptyList());</span>
<span class="fc" id="L105">                multiDigestWrapper.checkFixity();</span>
            }
        }

<span class="pc bpc" id="L109" title="1 of 4 branches missed.">        if (externalContent != null &amp;&amp; externalContent.getContentType() != null) {</span>
<span class="fc" id="L110">            mimeType = externalContent.getContentType();</span>
        }

<span class="fc" id="L113">        final ResourceOperation createOp = builder</span>
<span class="fc" id="L114">                .parentId(parentId)</span>
<span class="fc" id="L115">                .userPrincipal(userPrincipal)</span>
<span class="fc" id="L116">                .contentDigests(digest)</span>
<span class="fc" id="L117">                .mimeType(mimeType)</span>
<span class="fc" id="L118">                .contentSize(size)</span>
<span class="fc" id="L119">                .filename(filename)</span>
<span class="fc" id="L120">                .build();</span>

<span class="fc" id="L122">        lockParent(tx, pSession, parentId);</span>
<span class="fc" id="L123">        tx.lockResourceAndGhostNodes(fedoraId);</span>

        try {
<span class="fc" id="L126">            pSession.persist(createOp);</span>
<span class="nc" id="L127">        } catch (final PersistentStorageException exc) {</span>
<span class="nc" id="L128">            throw new RepositoryRuntimeException(String.format(&quot;failed to create resource %s&quot;, fedoraId), exc);</span>
<span class="fc" id="L129">        }</span>

        // Populate the description for the new binary
<span class="fc" id="L132">        createDescription(tx, pSession, userPrincipal, fedoraId);</span>
<span class="fc" id="L133">        addToContainmentIndex(tx, parentId, fedoraId);</span>
<span class="fc" id="L134">        membershipService.resourceCreated(tx, fedoraId);</span>
<span class="fc" id="L135">        addToSearchIndex(tx, fedoraId, pSession);</span>
<span class="fc" id="L136">        recordEvent(tx, fedoraId, createOp);</span>
<span class="fc" id="L137">    }</span>

    private void createDescription(final Transaction tx,
                                   final PersistentStorageSession pSession,
                                   final String userPrincipal,
                                   final FedoraId binaryId) {
<span class="fc" id="L143">        final var descId = binaryId.asDescription();</span>
<span class="fc" id="L144">        final var createOp = rdfSourceOperationFactory.createBuilder(</span>
                    tx,
                    descId,
                    FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI,
<span class="fc" id="L148">                    fedoraPropsConfig.getServerManagedPropsMode()</span>
<span class="fc" id="L149">                ).userPrincipal(userPrincipal)</span>
<span class="fc" id="L150">                .parentId(binaryId)</span>
<span class="fc" id="L151">                .build();</span>

        // ghost nodes would be handled on the binary, so just lock the description.
<span class="fc" id="L154">        tx.lockResource(descId);</span>

        try {
<span class="fc" id="L157">            pSession.persist(createOp);</span>
<span class="fc" id="L158">            userTypesCache.cacheUserTypes(descId, Collections.emptyList(), pSession.getId());</span>
<span class="nc" id="L159">        } catch (final PersistentStorageException exc) {</span>
<span class="nc" id="L160">            throw new RepositoryRuntimeException(String.format(&quot;failed to create description %s&quot;, descId), exc);</span>
<span class="fc" id="L161">        }</span>
<span class="fc" id="L162">    }</span>

    @Override
    public void perform(final Transaction tx, final String userPrincipal, final FedoraId fedoraId,
            final List&lt;String&gt; linkHeaders, final Model model) {
<span class="fc" id="L167">        final PersistentStorageSession pSession = this.psManager.getSession(tx);</span>
<span class="fc" id="L168">        checkAclLinkHeader(linkHeaders);</span>
        // Locate a containment parent of fedoraId, if exists.
<span class="fc" id="L170">        final FedoraId parentId = containmentIndex.getContainerIdByPath(tx, fedoraId, true);</span>
<span class="fc" id="L171">        checkParent(pSession, parentId);</span>

<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        final List&lt;String&gt; rdfTypes = isEmpty(linkHeaders) ? emptyList() : getTypes(linkHeaders);</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        final String interactionModel = determineInteractionModel(rdfTypes, true,</span>
                model != null, false);

<span class="fc" id="L177">        final RdfStream stream = fromModel(model.getResource(fedoraId.getFullId()).asNode(), model);</span>

<span class="fc" id="L179">        ensureValidDirectContainer(fedoraId, interactionModel, model);</span>

<span class="fc" id="L181">        final RdfSourceOperation createOp = rdfSourceOperationFactory</span>
<span class="fc" id="L182">                .createBuilder(tx, fedoraId, interactionModel, fedoraPropsConfig.getServerManagedPropsMode())</span>
<span class="fc" id="L183">                .parentId(parentId)</span>
<span class="fc" id="L184">                .triples(stream)</span>
<span class="fc" id="L185">                .relaxedProperties(model)</span>
<span class="fc" id="L186">                .archivalGroup(rdfTypes.contains(ARCHIVAL_GROUP.getURI()))</span>
<span class="fc" id="L187">                .userPrincipal(userPrincipal)</span>
<span class="fc" id="L188">                .build();</span>

<span class="fc" id="L190">        lockParent(tx, pSession, parentId);</span>
<span class="fc" id="L191">        tx.lockResourceAndGhostNodes(fedoraId);</span>

        try {
<span class="fc" id="L194">            pSession.persist(createOp);</span>
<span class="nc" id="L195">        } catch (final PersistentStorageException exc) {</span>
<span class="nc" id="L196">            throw new RepositoryRuntimeException(String.format(&quot;failed to create resource %s&quot;, fedoraId), exc);</span>
<span class="fc" id="L197">        }</span>

<span class="fc" id="L199">        userTypesCache.cacheUserTypes(fedoraId,</span>
<span class="fc" id="L200">                fromModel(model.getResource(fedoraId.getFullId()).asNode(), model), pSession.getId());</span>

<span class="fc" id="L202">        updateReferences(tx, fedoraId, userPrincipal, model);</span>
<span class="fc" id="L203">        addToContainmentIndex(tx, parentId, fedoraId);</span>
<span class="fc" id="L204">        membershipService.resourceCreated(tx, fedoraId);</span>
<span class="fc" id="L205">        addToSearchIndex(tx, fedoraId, pSession);</span>
<span class="fc" id="L206">        recordEvent(tx, fedoraId, createOp);</span>
<span class="fc" id="L207">    }</span>

    private void addToSearchIndex(final Transaction tx, final FedoraId fedoraId,
                                  final PersistentStorageSession persistentStorageSession) {
<span class="fc" id="L211">        final var resourceHeaders = persistentStorageSession.getHeaders(fedoraId, null);</span>
<span class="fc" id="L212">        this.searchIndex.addUpdateIndex(tx, resourceHeaders);</span>
<span class="fc" id="L213">    }</span>

    /**
     * Check the parent to contain the new resource exists and can have a child.
     *
     * @param pSession a persistence session.
     * @param fedoraId Id of parent.
     */
    private void checkParent(final PersistentStorageSession pSession, final FedoraId fedoraId)
        throws RepositoryRuntimeException {

<span class="pc bpc" id="L224" title="1 of 4 branches missed.">        if (fedoraId != null &amp;&amp; !fedoraId.isRepositoryRoot()) {</span>
            final ResourceHeaders parent;
            try {
                // Make sure the parent exists.
                // TODO: object existence can be from the index, but we don't have interaction model. Should we add it?
<span class="fc" id="L229">                parent = pSession.getHeaders(fedoraId.asResourceId(), null);</span>
<span class="nc" id="L230">            } catch (final PersistentItemNotFoundException exc) {</span>
<span class="nc" id="L231">                throw new ItemNotFoundException(String.format(&quot;Item %s was not found&quot;, fedoraId), exc);</span>
<span class="nc" id="L232">            } catch (final PersistentStorageException exc) {</span>
<span class="nc" id="L233">                throw new RepositoryRuntimeException(String.format(&quot;Failed to find storage headers for %s&quot;, fedoraId),</span>
                    exc);
<span class="fc" id="L235">            }</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">            if (parent.isDeleted()) {</span>
<span class="nc" id="L237">                throw new CannotCreateResourceException(</span>
<span class="nc" id="L238">                        String.format(&quot;Cannot create resource as child of a tombstone. Tombstone found at %s&quot;,</span>
<span class="nc" id="L239">                                fedoraId.getFullIdPath()));</span>
            }
<span class="fc" id="L241">            final boolean isParentBinary = NON_RDF_SOURCE.toString().equals(parent.getInteractionModel());</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">            if (isParentBinary) {</span>
                // Binary is not a container, can't have children.
<span class="fc" id="L244">                throw new InteractionModelViolationException(&quot;NonRdfSource resources cannot contain other resources&quot;);</span>
            }
            // TODO: Will this type still be needed?
<span class="fc" id="L247">            final boolean isPairTree = FEDORA_PAIR_TREE.toString().equals(parent.getInteractionModel());</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            if (isPairTree) {</span>
<span class="nc" id="L249">                throw new CannotCreateResourceException(&quot;Objects cannot be created under pairtree nodes&quot;);</span>
            }
        }
<span class="fc" id="L252">    }</span>

    /**
     * Get the rel=&quot;type&quot; link headers from a list of them.
     * @param headers a list of string LINK headers.
     * @return a list of LINK headers with rel=&quot;type&quot;
     */
    private List&lt;String&gt; getTypes(final List&lt;String&gt; headers) {
<span class="nc" id="L260">        final List&lt;Link&gt; hdrobjs = getLinkHeaders(headers);</span>
        try {
<span class="nc bnc" id="L262" title="All 2 branches missed.">            return hdrobjs == null ? emptyList() : hdrobjs.stream()</span>
<span class="nc" id="L263">                    .filter(p -&gt; p.getRel().equalsIgnoreCase(&quot;type&quot;)).map(Link::getUri)</span>
<span class="nc" id="L264">                    .map(URI::toString).collect(Collectors.toList());</span>
<span class="nc" id="L265">        } catch (final Exception e ) {</span>
<span class="nc" id="L266">            throw new BadRequestException(&quot;Invalid Link header type found&quot;,e);</span>
        }
    }

    /**
     * Converts a list of string LINK headers to actual LINK objects.
     * @param headers the list of string link headers.
     * @return the list of LINK headers.
     */
    private List&lt;Link&gt; getLinkHeaders(final List&lt;String&gt; headers) {
<span class="nc bnc" id="L276" title="All 2 branches missed.">        return headers == null ? null : headers.stream().map(Link::valueOf).collect(Collectors.toList());</span>
    }

    /**
     * Add this pairing to the containment index.
     * @param tx The transaction.
     * @param parentId The parent ID.
     * @param id The child ID.
     */
    private void addToContainmentIndex(final Transaction tx, final FedoraId parentId, final FedoraId id) {
<span class="fc" id="L286">        containmentIndex.addContainedBy(tx, parentId, id);</span>
<span class="fc" id="L287">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>