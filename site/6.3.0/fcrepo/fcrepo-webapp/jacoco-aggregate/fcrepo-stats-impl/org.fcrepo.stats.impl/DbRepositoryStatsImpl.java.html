<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DbRepositoryStatsImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Repository Deployable Web Application</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-stats-impl</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.stats.impl</a> &gt; <span class="el_source">DbRepositoryStatsImpl.java</span></div><h1>DbRepositoryStatsImpl.java</h1><pre class="source lang-java linenums">/*
 * The contents of this file are subject to the license and copyright
 * detailed in the LICENSE and NOTICE files at the root of the source
 * tree.
 */
package org.fcrepo.stats.impl;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import javax.sql.DataSource;

import org.fcrepo.kernel.api.RdfLexicon;
import org.fcrepo.stats.api.MimeTypeStatsResult;
import org.fcrepo.stats.api.RdfTypeStatsResult;
import org.fcrepo.stats.api.RepositoryStats;
import org.fcrepo.stats.api.RepositoryStatsByMimeTypeResults;
import org.fcrepo.stats.api.RepositoryStatsByRdfTypeResults;
import org.fcrepo.stats.api.RepositoryStatsParameters;
import org.fcrepo.stats.api.RepositoryStatsResult;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.support.rowset.SqlRowSet;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

/**
 * A database-backed implementation of the &lt;code&gt;RepositoryStats&lt;/code&gt; interface.
 * It depends on the tables that drive the search index.
 *
 * @author dbernstein
 */
@Component(&quot;stats&quot;)
<span class="fc" id="L36">public class DbRepositoryStatsImpl implements RepositoryStats {</span>

    private static final String SELECT_COUNT_FROM_SIMPLE_SEARCH = &quot;select count(*) from simple_search&quot;;

    @Inject
    private DataSource dataSource;

    private NamedParameterJdbcTemplate jdbcTemplate;

    /**
     * Setup template
     */
    @PostConstruct
    public void setup() {
<span class="fc" id="L50">        this.jdbcTemplate = new NamedParameterJdbcTemplate(this.dataSource);</span>
<span class="fc" id="L51">    }</span>


    @Override
    public RepositoryStatsResult getResourceCount(final RepositoryStatsParameters statsParams) {
<span class="fc" id="L56">        final var parameterSource = new MapSqlParameterSource();</span>
<span class="fc" id="L57">        final var results = jdbcTemplate.queryForRowSet(SELECT_COUNT_FROM_SIMPLE_SEARCH, parameterSource);</span>
<span class="fc" id="L58">        results.first();</span>
<span class="fc" id="L59">        final var result = new RepositoryStatsResult();</span>
<span class="fc" id="L60">        result.setResourceCount(results.getLong(1));</span>
<span class="fc" id="L61">        return result;</span>
    }

    @Override
    public RepositoryStatsByMimeTypeResults getByMimeTypes(final RepositoryStatsParameters statsParams) {
<span class="fc" id="L66">        final var results = new RepositoryStatsByMimeTypeResults();</span>
<span class="fc" id="L67">        final var mimeTypes = statsParams.getMimeTypes();</span>
<span class="fc" id="L68">        final var parameterSource = new MapSqlParameterSource();</span>
<span class="fc" id="L69">        final var mimeTypesQuery = formatMimetypeQuery(mimeTypes, parameterSource);</span>
<span class="fc" id="L70">        final var mimetypeResults = jdbcTemplate.queryForRowSet(mimeTypesQuery, parameterSource);</span>
<span class="fc" id="L71">        marshallMimeTypeResults(results, mimetypeResults);</span>
<span class="fc" id="L72">        return results;</span>
    }

    @Override
    public RepositoryStatsByRdfTypeResults getByRdfType(final RepositoryStatsParameters statsParams) {
<span class="fc" id="L77">        final var results = new RepositoryStatsByRdfTypeResults();</span>
<span class="fc" id="L78">        final var parameterSource = new MapSqlParameterSource();</span>
<span class="fc" id="L79">        final var query = formatRdfTypeQuery(statsParams.getRdfTypes(), parameterSource);</span>
<span class="fc" id="L80">        final var rdfTypeResults = jdbcTemplate.queryForRowSet(query, parameterSource);</span>
<span class="fc" id="L81">        marshallRdfTypeResults(results, rdfTypeResults);</span>
<span class="fc" id="L82">        return results;</span>
    }

    private void marshallMimeTypeResults(final RepositoryStatsByMimeTypeResults results,
                                         final SqlRowSet mimeTypeResults) {
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (mimeTypeResults.first()) {</span>
<span class="fc" id="L88">            final var mimeTypesResultList = new ArrayList&lt;MimeTypeStatsResult&gt;();</span>
            do {
<span class="fc" id="L90">                final var mimeTypeResult = new MimeTypeStatsResult();</span>
<span class="fc" id="L91">                mimeTypeResult.setMimeType(mimeTypeResults.getString(1));</span>
<span class="fc" id="L92">                mimeTypeResult.setResourceCount(mimeTypeResults.getLong(2));</span>
<span class="fc" id="L93">                mimeTypeResult.setByteCount(mimeTypeResults.getLong(3));</span>
<span class="fc" id="L94">                mimeTypesResultList.add(mimeTypeResult);</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">            } while (mimeTypeResults.next());</span>
<span class="fc" id="L96">            results.setMimeTypes(mimeTypesResultList);</span>
        }
<span class="fc" id="L98">    }</span>

    private String formatMimetypeQuery(final List&lt;String&gt; mimeTypes, final MapSqlParameterSource parameterSource) {
<span class="fc" id="L101">        final var mimeTypesQuery = new StringBuilder(&quot;select a.mime_type, count(a.id), sum(a.content_size) &quot;);</span>
<span class="fc" id="L102">        mimeTypesQuery.append(&quot;from simple_search a, search_resource_rdf_type b,  search_rdf_type c &quot;);</span>
<span class="fc" id="L103">        mimeTypesQuery.append(&quot;where a.id = b.resource_id and b.rdf_type_id = c.id and c.rdf_type_uri = '&quot;);</span>
<span class="fc" id="L104">        mimeTypesQuery.append(RdfLexicon.NON_RDF_SOURCE.getURI());</span>
<span class="fc" id="L105">        mimeTypesQuery.append(&quot;' &quot;);</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(mimeTypes)) {</span>
<span class="fc" id="L107">            mimeTypesQuery.append(&quot;and a.mime_type in (:mime_types) &quot;);</span>
<span class="fc" id="L108">            parameterSource.addValue(&quot;mime_types&quot;, mimeTypes);</span>
        }
<span class="fc" id="L110">        mimeTypesQuery.append(&quot;group by a.mime_type order by a.mime_type&quot;);</span>
<span class="fc" id="L111">        return mimeTypesQuery.toString();</span>
    }

    private void marshallRdfTypeResults(final RepositoryStatsByRdfTypeResults results,
                                        final SqlRowSet rdfTypeResults) {
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (rdfTypeResults.first()) {</span>
<span class="fc" id="L117">            final var resourceTypeStatsResults = new ArrayList&lt;RdfTypeStatsResult&gt;();</span>
            do {
<span class="fc" id="L119">                final var resourceTypeResult = new RdfTypeStatsResult();</span>
<span class="fc" id="L120">                resourceTypeResult.setResourceType(rdfTypeResults.getString(1));</span>
<span class="fc" id="L121">                resourceTypeResult.setResourceCount(rdfTypeResults.getLong(2));</span>
<span class="fc" id="L122">                resourceTypeResult.setByteCount(rdfTypeResults.getLong(3));</span>
<span class="fc" id="L123">                resourceTypeStatsResults.add(resourceTypeResult);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">            } while (rdfTypeResults.next());</span>
<span class="fc" id="L125">            results.setRdfTypes(resourceTypeStatsResults);</span>
        }
<span class="fc" id="L127">    }</span>


    private String formatRdfTypeQuery(final List&lt;String&gt; rdfTypes, final MapSqlParameterSource parameterSource) {
<span class="fc" id="L131">        final var rdfTypesQuery = new StringBuilder(</span>
                &quot;select c.rdf_type_uri, count(b.resource_id), sum(a.content_size) &quot;);
<span class="fc" id="L133">        rdfTypesQuery.append(&quot;from simple_search a, search_resource_rdf_type b,  search_rdf_type c &quot;);</span>
<span class="fc" id="L134">        rdfTypesQuery.append(&quot;where a.id = b.resource_id and b.rdf_type_id = c.id &quot;);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(rdfTypes)) {</span>
<span class="fc" id="L136">            rdfTypesQuery.append(&quot;and c.rdf_type_uri in (:rdf_types) &quot;);</span>
<span class="fc" id="L137">            parameterSource.addValue(&quot;rdf_types&quot;, rdfTypes);</span>
        }
<span class="fc" id="L139">        rdfTypesQuery.append(&quot;group by c.rdf_type_uri&quot;);</span>
<span class="fc" id="L140">        return rdfTypesQuery.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>